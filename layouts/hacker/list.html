{{ partial "header.html" . }}

{{- $hacker := .Data.Term -}}

{{- $videoParams := slice -}}
{{- $categoryCounts := dict -}}
{{- $tools := slice -}}
{{- $collaborators := dict -}}
{{- $focusAreaData := dict -}}

<!-- Get all focus areas and their related tags -->
{{- $focusAreas := $.Site.GetPage "section" "focusarea" -}}
{{- $focusAreaMapping := dict -}}
{{- range $focusAreas.Pages -}}
  {{ . }}
  {{- if .Params.related_tags -}}
    {{- $areaName := path.Base .File.Dir -}}
    {{- $focusAreaMapping = merge $focusAreaMapping (dict $areaName .Params.related_tags) -}}
  {{- end -}}
{{- end -}}

<!-- Extracting Useful data -->
{{- range .Pages -}}
  <!-- Video playlist generation -->
  {{- if and .Params.video (in .Params.video "youtube.com") -}}
    {{- range (split .Params.video " ") -}}
      {{- $videoID := index (split . "?v=") 1 | default "" -}}
      {{- if $videoID -}}
        {{- $videoParams = $videoParams | append $videoID -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  <!-- Session Type Count -->
  {{- $category := .Params.type -}}
  {{- if $category -}}
    {{- $categoryCounts = merge $categoryCounts (dict $category (add (index $categoryCounts $category | default 0) 1)) -}}
  {{- end -}}

  <!-- Tools Section -->
  {{- $tool := .Params.tool -}}
  {{- if $tool -}}
    {{- if eq (printf "%T" $tool) "string" -}}
      {{- $tools = $tools | append (upper $tool) -}}
    {{- else if eq (printf "%T" $tool) "[]string" -}}
      {{- $tools = $tools | append (apply $tool "upper" ".") -}}
    {{- end -}}
  {{- end -}}

  <!-- Collaborator Section -->
  {{- range .Params.hacker -}}
    {{- $collab := . | lower -}}
    {{- if and (ne $collab $hacker) (ne $collab "") -}}
      {{- $collaborators = merge $collaborators (dict $collab (add (index $collaborators $collab | default 0) 1)) -}}
    {{- end -}}
  {{- end -}}

  <!-- Focus Area Timeline Data -->
  {{- if .Params.tag -}}
    {{- range .Params.tag -}}
      {{- $tag := . | lower -}}
      {{- /* Find which focus area this tag belongs to */ -}}
      {{- $matchingFocusArea := "" -}}
      {{- range $focusAreaName, $relatedTags := $focusAreaMapping -}}
        {{- if in $relatedTags $tag -}}
          {{- $matchingFocusArea = $focusAreaName -}}
          {{- break -}}
        {{- end -}}
      {{- end -}}
      
      {{- if $matchingFocusArea -}}
        {{- $existingData := index $focusAreaData $matchingFocusArea -}}
        {{- if not $existingData -}}
          {{- $focusAreaData = merge $focusAreaData (dict $matchingFocusArea (dict "count" 1 "first_talk" $.Date "last_talk" $.Date)) -}}
        {{- else -}}
          {{- $currentDate := $.Date -}}
          {{- $firstTalk := $existingData.first_talk -}}
          {{- $lastTalk := $existingData.last_talk -}}
          {{- if $currentDate.Before $firstTalk -}}
            {{- $firstTalk = $currentDate -}}
          {{- end -}}
          {{- if $currentDate.After $lastTalk -}}
            {{- $lastTalk = $currentDate -}}
          {{- end -}}
          {{- $focusAreaData = merge $focusAreaData (dict $matchingFocusArea (dict "count" (add $existingData.count 1) "first_talk" $firstTalk "last_talk" $lastTalk)) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

{{- end -}}

<center>
  <div class="card">
    {{- $imgBasePath := path.Join "static" "hacker" $hacker -}}
    {{- $extensions := slice ".jpg" ".png" ".jpeg" ".jfif" -}}
    {{- $photopath := "" -}}
    
    {{- range $ext := $extensions -}}
      {{- if (fileExists (print $imgBasePath $ext)) -}}
        {{- $photopath = print "/hacker/" $hacker $ext -}}
        {{- break -}}
      {{- end -}}
    {{- end -}}

    {{- if $photopath }}
      <img class="profilephoto" src="{{ $photopath }}" alt="Avatar">
    {{ end }}

    <div class="container">
      <h2><b>{{ .Title | markdownify | title }}</b></h2>
      <p>{{ partial "social.html" . }}</p>

      {{ if gt (len $videoParams) 0 }}
        <a href="https://www.youtube.com/watch_videos?video_ids={{ delimit $videoParams "," }}" target="_blank" rel="noreferrer noopener">Dynamic Video Playlist</a>
      {{ end }}
    </div>
  </div>
</center>

{{- if len $categoryCounts -}}
  <hr />
  <b>Activities:</b>
  <i>{{ range $category, $count := $categoryCounts }}
    {{ $category | humanize | title }} - {{ $count }};
  {{ end }}</i>
{{ end }}

<!-- Deduplicate and Display Tools -->
{{- $uniqueTools := slice -}}
{{- range $tools -}}
  {{- if not (in $uniqueTools .) -}}
    {{- $uniqueTools = $uniqueTools | append ( upper .) -}}
  {{- end -}}
{{- end -}}

{{ if len $uniqueTools }}
  <hr />
  <b>Tools Contributed or Authored:&nbsp;</b>
  {{ range $uniqueTools }}
    <b><a href="/tool/{{ . | urlize }}">{{ . }}</a></b>&nbsp;
  {{ end }}
{{ end }}

<!-- Filter and display common collaborators with more than 2 contributions -->
{{- $commonCollaborators := slice -}}
{{- range $name, $count := $collaborators -}}
  {{- if gt $count 1 -}}
    {{- $commonCollaborators = $commonCollaborators | append (dict "name" $name "count" $count) -}}
  {{- end -}}
{{- end -}}

{{ if gt (len $commonCollaborators) 0 }}
<hr />
<b>Common Collaborators:</b>
    {{ range $name, $count := (sort $commonCollaborators "count" "desc" ) }}
        <a href="/hacker/{{ .name }}"><b>{{ .name | humanize | title }}({{ .count }})</b></a>;
    {{ end }}
{{ end }}

<!-- Common Tags Section (tag count > 2 only) -->
{{- $commonTags := slice -}}
{{- range $tag, $data := $focusAreaData -}}
  {{- if gt $data.count 2 -}}
    {{- $commonTags = $commonTags | append (dict "tag" $tag "count" $data.count) -}}
  {{- end -}}
{{- end -}}

{{ if gt (len $commonTags) 0 }}
<hr />
<b>Common Topics (3+ talks):</b>
    {{ range (sort $commonTags "count" "desc") }}
        <a href="/tag/{{ .tag | urlize }}/"><b>{{ .tag | humanize | title }}({{ .count }})</b></a>;
    {{ end }}
{{ end }}

<!-- Focus Areas Section -->
{{- $focusAreas := slice -}}
{{- range $tag, $data := $focusAreaData -}}
  {{- $focusAreas = $focusAreas | append (dict "tag" $tag "data" $data) -}}
{{- end -}}

{{ if gt (len $focusAreas) 0 }}
<hr />
<b>Focus Areas Timeline:</b>
<div style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-left: 4px solid #007bff;">
  <h3>Focus Areas Overview</h3>
  {{ range (sort $focusAreas "data.count" "desc") }}
    {{ $tag := .tag }}
    {{ $data := .data }}
    <div style="margin: 10px 0; padding: 10px; background-color: white; border-radius: 5px;">
      <h4><a href="/tag/{{ $tag | urlize }}/">{{ $tag | humanize | title }}</a> ({{ $data.count }} talks)</h4>
      <p><strong>Timeline:</strong> {{ $data.first_talk.Format "2006" }} - {{ $data.last_talk.Format "2006" }}</p>
      <p><strong>Duration:</strong> {{ sub $data.last_talk.Year $data.first_talk.Year }} years</p>
      
      <!-- Simple Gantt Chart -->
      <div style="margin: 10px 0;">
        <div style="display: flex; align-items: center; margin-bottom: 5px;">
          <span style="min-width: 120px; font-size: 12px;">Timeline:</span>
          <div style="flex: 1; height: 20px; background-color: #e9ecef; border-radius: 10px; position: relative; margin: 0 10px;">
            {{ $totalYears := sub $data.last_talk.Year $data.first_talk.Year }}
            {{ if eq $totalYears 0 }}
              {{ $totalYears = 1 }}
            {{ end }}
            {{ $startOffset := 0 }}
            {{ $width := mul (div (sub $data.last_talk.Year $data.first_talk.Year | float) $totalYears) 100 }}
            <div style="position: absolute; left: {{ $startOffset }}%; width: {{ $width }}%; height: 100%; background-color: #007bff; border-radius: 10px;"></div>
          </div>
          <span style="font-size: 12px; color: #666;">{{ $data.first_talk.Format "2006" }} - {{ $data.last_talk.Format "2006" }}</span>
        </div>
      </div>
      
      <!-- List of talks in this focus area -->
      <details style="margin-top: 10px;">
        <summary style="cursor: pointer; color: #007bff;">Show {{ $data.count }} talks</summary>
        <ul style="margin: 5px 0; padding-left: 20px;">
          {{ range where $.Pages "Params.tag" "intersect" (slice $tag) }}
            <li style="margin: 2px 0;">
              <span style="color: #666;">{{ .Date.Format "2006/01/02" }}</span> - 
              <a href="{{ .RelPermalink }}">{{ .Title | markdownify }}</a>
              {{ if .Params.conference }}
                at <a href="/conference/{{ .Params.conference | urlize }}/">{{ .Params.conference | humanize | title }}</a>
              {{ end }}
            </li>
          {{ end }}
        </ul>
      </details>
    </div>
  {{ end }}
</div>
{{ end }}

<hr />  
<h1>Hacktivity</h1>
<hr />
{{ range .Pages.GroupByDate "2006" }}
  <center class="year-key"><b>---- {{ .Key }} ----</b></center>
  <ul>
    {{ range .Pages }}
      <li>
        <span class="date">{{ .Date.Format "2006/01/02" }}</span>
        <a href="/type/{{ .Params.type | urlize }}/">{{ .Params.type | humanize | title }}</a> :
        <a href="/{{ cond .Params.award (printf "award/%s" .Params.award) (printf "conference/%s" .Params.conference) | lower | urlize }}">{{ cond .Params.award .Params.award .Params.conference | humanize | title }}</a>
        : <a href="{{ .RelPermalink }}">{{ .Title | markdownify }}</a> -
        {{- range .Params.hacker -}}<a href="/hacker/{{ . }}/">{{ . | humanize | title }}</a> {{ end }}
        {{- range .Params.morehackers -}}<u>{{- . | humanize | title -}}</u>&nbsp;{{- end -}}
        {{- $paramValue := .Params -}}
        {{- range (slice "presentation" "whitepaper" "Source" "video") -}}
          {{- $type := . -}}
          {{- $val := index $paramValue $type -}}
          {{- with $val -}}
            <a href="{{ . }}" target="_blank" rel="noreferrer noopener nofollow">
              <img src="/fontawesome/{{ $type | lower }}.svg" style="width:15px; padding-left:2px;">
            </a>
          {{- end -}}
        {{- end -}}

      </li>
    {{ end }}
  </ul>
{{ end }}

{{ partial "footer.html" . }}
